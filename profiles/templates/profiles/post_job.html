{% extends 'base.html' %}

{% block title %}Post a Job - LockedIn{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-plus me-2"></i>Post a New Job
                    </h1>
                    <p class="text-muted mb-0">Create a job posting to attract talented candidates</p>
                </div>
                <div class="card-body">
                    <form method="post" id="simplePostJobForm">
                        {% csrf_token %}
                        <input type="hidden" name="save_action" id="save_action" value="publish">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">Job Title *</label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger small">{{ form.title.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.company.id_for_label }}" class="form-label">Company *</label>
                                {{ form.company }}
                                {% if form.company.errors %}
                                    <div class="text-danger small">{{ form.company.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.location.id_for_label }}" class="form-label">Location *</label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                    <div class="text-danger small">{{ form.location.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.work_location.id_for_label }}" class="form-label">Work Location *</label>
                                {{ form.work_location }}
                                {% if form.work_location.errors %}
                                    <div class="text-danger small">{{ form.work_location.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.employment_type.id_for_label }}" class="form-label">Employment Type *</label>
                                {{ form.employment_type }}
                                {% if form.employment_type.errors %}
                                    <div class="text-danger small">{{ form.employment_type.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Map Location Picker Section (Story 17) -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt me-2"></i>Pin Office Location on Map
                            </label>
                            <div class="alert alert-info py-2">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Two ways to pin location:</strong>
                                <ol class="mb-0 mt-1 ps-3">
                                    <li>Enter an address above in "Location" field and click "Find on Map" below</li>
                                    <li>Or click directly on the map to pin the exact location</li>
                                </ol>
                            </div>

                            <!-- Find Address Button -->
                            <div class="mb-2">
                                <button type="button" class="btn btn-primary btn-sm" id="geocodeBtn">
                                    <i class="fas fa-search me-1"></i>Find Location on Map
                                </button>
                                <small class="text-muted ms-2" id="geocodeStatus"></small>
                            </div>

                            <div id="locationMap" style="height: 400px; width: 100%; border-radius: 8px; border: 2px solid #e5e7eb; margin-bottom: 10px;"></div>

                            <!-- Hidden lat/lng fields -->
                            <div style="display: none;">
                                {{ form.latitude }}
                                {{ form.longitude }}
                            </div>

                            <!-- Status indicator -->
                            <div id="mapStatus" class="alert alert-success py-2" style="display: none;">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="mapStatusText">Location pinned successfully!</span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">Category *</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                    <div class="text-danger small">{{ form.category.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.experience_level.id_for_label }}" class="form-label">Experience Level *</label>
                                {{ form.experience_level }}
                                {% if form.experience_level.errors %}
                                    <div class="text-danger small">{{ form.experience_level.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.salary_min.id_for_label }}" class="form-label">Minimum Salary</label>
                                {{ form.salary_min }}
                                {% if form.salary_min.errors %}
                                    <div class="text-danger small">{{ form.salary_min.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.salary_max.id_for_label }}" class="form-label">Maximum Salary</label>
                                {{ form.salary_max }}
                                {% if form.salary_max.errors %}
                                    <div class="text-danger small">{{ form.salary_max.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.salary_period.id_for_label }}" class="form-label">Salary Period</label>
                                {{ form.salary_period }}
                                {% if form.salary_period.errors %}
                                    <div class="text-danger small">{{ form.salary_period.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.salary_currency.id_for_label }}" class="form-label">Currency</label>
                                {{ form.salary_currency }}
                                {% if form.salary_currency.errors %}
                                    <div class="text-danger small">{{ form.salary_currency.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Job Description *</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="text-danger small">{{ form.description.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                Describe the role, responsibilities, and what makes this opportunity special.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.requirements.id_for_label }}" class="form-label">Requirements</label>
                            {{ form.requirements }}
                            {% if form.requirements.errors %}
                                <div class="text-danger small">{{ form.requirements.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                List the required skills, experience, and qualifications.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.responsibilities.id_for_label }}" class="form-label">Responsibilities</label>
                            {{ form.responsibilities }}
                            {% if form.responsibilities.errors %}
                                <div class="text-danger small">{{ form.responsibilities.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                Outline the key responsibilities and daily tasks.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.benefits.id_for_label }}" class="form-label">Benefits & Perks</label>
                            {{ form.benefits }}
                            {% if form.benefits.errors %}
                                <div class="text-danger small">{{ form.benefits.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                Describe benefits, perks, and what makes your company great.
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.application_deadline.id_for_label }}" class="form-label">Application Deadline</label>
                            {{ form.application_deadline }}
                            {% if form.application_deadline.errors %}
                                <div class="text-danger small">{{ form.application_deadline.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                Optional: Set a deadline for applications.
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'my_job_postings' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Cancel
                            </a>
                            <div class="ms-auto d-flex gap-2">
                                <button type="submit" class="btn btn-outline-secondary" name="save_action" value="save_draft" formnovalidate>
                                    <i class="fas fa-save me-1"></i>Save as Draft
                                </button>
                                <button type="submit" class="btn btn-primary" id="publishBtn" name="save_action" value="publish">
                                    <i class="fas fa-paper-plane me-2"></i>Post Job
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Tips Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h4 class="h5 mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Tips for a Great Job Posting
                    </h4>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Be specific:</strong> Clearly define the role and responsibilities
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Highlight benefits:</strong> Mention what makes your company special
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>List requirements clearly:</strong> Help candidates self-assess their fit
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>Include salary range:</strong> Attract more qualified candidates
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    border: 1px solid var(--border-color);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.card-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid var(--border-color);
}

.form-label {
    font-weight: 600;
    color: var(--dark-text);
}

.form-text {
    color: var(--secondary-color);
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS and JS for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('simplePostJobForm');

    // Initialize the location picker map (Story 17)
    const latInput = document.getElementById('{{ form.latitude.id_for_label }}');
    const lonInput = document.getElementById('{{ form.longitude.id_for_label }}');
    const locationInput = document.getElementById('{{ form.location.id_for_label }}');

    // Initialize map centered on US or existing coordinates
    let initialLat = parseFloat(latInput.value) || 39.8283;
    let initialLon = parseFloat(lonInput.value) || -98.5795;
    let initialZoom = (latInput.value && lonInput.value) ? 13 : 4;

    const locationMap = L.map('locationMap').setView([initialLat, initialLon], initialZoom);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(locationMap);

    // Create a marker for the office location
    let marker = null;
    if (latInput.value && lonInput.value) {
        marker = L.marker([parseFloat(latInput.value), parseFloat(lonInput.value)], {
            draggable: true
        }).addTo(locationMap);

        // Update coordinates when marker is dragged
        marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            latInput.value = pos.lat.toFixed(6);
            lonInput.value = pos.lng.toFixed(6);
        });
    }

    // Helper function to add/update marker
    function addMarkerAtLocation(lat, lon, message) {
        // Update form fields
        latInput.value = lat.toFixed(6);
        lonInput.value = lon.toFixed(6);

        // Remove existing marker if any
        if (marker) {
            locationMap.removeLayer(marker);
        }

        // Add new draggable marker
        marker = L.marker([lat, lon], {
            draggable: true
        }).addTo(locationMap);

        // Update coordinates when marker is dragged
        marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            latInput.value = pos.lat.toFixed(6);
            lonInput.value = pos.lng.toFixed(6);
            showMapStatus('Location updated by dragging marker');
        });

        marker.bindPopup(`<b>Office Location</b><br>${message || 'Click and drag to adjust'}`).openPopup();

        // Show success message
        showMapStatus(message || 'Location pinned successfully!');
    }

    // Helper function to show status
    function showMapStatus(message) {
        const statusDiv = document.getElementById('mapStatus');
        const statusText = document.getElementById('mapStatusText');
        statusText.textContent = message;
        statusDiv.style.display = 'block';

        // Hide after 3 seconds
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }

    // Add marker on map click
    locationMap.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        addMarkerAtLocation(lat, lon, 'Location pinned by clicking map');
    });

    // Geocode button functionality
    const geocodeBtn = document.getElementById('geocodeBtn');
    const geocodeStatus = document.getElementById('geocodeStatus');

    if (geocodeBtn && locationInput) {
        geocodeBtn.addEventListener('click', function() {
            const locationText = locationInput.value.trim();

            if (!locationText) {
                geocodeStatus.textContent = 'Please enter a location first';
                geocodeStatus.className = 'text-danger ms-2';
                return;
            }

            // Show loading state
            geocodeBtn.disabled = true;
            geocodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Searching...';
            geocodeStatus.textContent = '';

            // Use Nominatim API to geocode
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationText)}`)
                .then(response => response.json())
                .then(data => {
                    geocodeBtn.disabled = false;
                    geocodeBtn.innerHTML = '<i class="fas fa-search me-1"></i>Find Location on Map';

                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        const displayName = data[0].display_name;

                        // Center map and add marker
                        locationMap.setView([lat, lon], 13);
                        addMarkerAtLocation(lat, lon, `Found: ${displayName}`);

                        geocodeStatus.textContent = '✓ Location found!';
                        geocodeStatus.className = 'text-success ms-2';
                    } else {
                        geocodeStatus.textContent = 'Location not found. Try clicking on the map instead.';
                        geocodeStatus.className = 'text-warning ms-2';
                    }
                })
                .catch(error => {
                    console.log('Geocoding error:', error);
                    geocodeBtn.disabled = false;
                    geocodeBtn.innerHTML = '<i class="fas fa-search me-1"></i>Find Location on Map';
                    geocodeStatus.textContent = 'Error searching. Please try clicking on the map.';
                    geocodeStatus.className = 'text-danger ms-2';
                });
        });
    }
});
</script>
{% endblock %}
